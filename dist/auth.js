function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _regeneratorRuntime(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */function b(a,b,c){return Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}),a[b]}function f(b,d,e,f){var g=d&&d.prototype instanceof k?d:k,h=Object.create(g.prototype),a=new B(f||[]);return E(h,"_invoke",{value:w(b,e,a)}),h}function j(a,b,c){try{return{type:"normal",arg:a.call(b,c)}}catch(a){return{type:"throw",arg:a}}}function k(){}function l(){}function m(){}function q(a){["next","throw","return"].forEach(function(c){b(a,c,function(a){return this._invoke(c,a)})})}function s(b,d){function c(e,f,g,i){var a=j(b[e],b,f);if("throw"!==a.type){var k=a.arg,l=k.value;return l&&"object"==_typeof(l)&&t.call(l,"__await")?d.resolve(l.__await).then(function(a){c("next",a,g,i)},function(a){c("throw",a,g,i)}):d.resolve(l).then(function(a){k.value=a,g(k)},function(a){return c("throw",a,g,i)})}i(a.arg)}var e;E(this,"_invoke",{value:function(a,b){function f(){return new d(function(d,e){c(a,b,d,e)})}return e=e?e.then(f,f):f()}})}function w(a,b,d){var e="suspendedStart";return function(f,g){if(e==="executing")throw Error("Generator is already running");if("completed"===e){if("throw"===f)throw g;return{value:D,done:!0}}for(d.method=f,d.arg=g;;){var h=d.delegate;if(h){var i=x(h,d);if(i){if(i===G)continue;return i}}if("next"===d.method)d.sent=d._sent=d.arg;else if("throw"===d.method){if("suspendedStart"===e)throw e="completed",d.arg;d.dispatchException(d.arg)}else"return"===d.method&&d.abrupt("return",d.arg);e="executing";var k=j(a,b,d);if("normal"===k.type){if(e=d.done?"completed":"suspendedYield",k.arg===G)continue;return{value:k.arg,done:d.done}}"throw"===k.type&&(e="completed",d.method="throw",d.arg=k.arg)}}}function x(b,c){var d=c.method,e=b.iterator[d];if(e===D)return c.delegate=null,"throw"===d&&b.iterator["return"]&&(c.method="return",c.arg=D,x(b,c),"throw"===c.method)||"return"!==d&&(c.method="throw",c.arg=new TypeError("The iterator does not provide a '"+d+"' method")),G;var f=j(e,b.iterator,c.arg);if("throw"===f.type)return c.method="throw",c.arg=f.arg,c.delegate=null,G;var g=f.arg;return g?g.done?(c[b.resultName]=g.value,c.next=b.nextLoc,"return"!==c.method&&(c.method="next",c.arg=D),c.delegate=null,G):g:(c.method="throw",c.arg=new TypeError("iterator result is not an object"),c.delegate=null,G)}function z(a){var b={tryLoc:a[0]};1 in a&&(b.catchLoc=a[1]),2 in a&&(b.finallyLoc=a[2],b.afterLoc=a[3]),this.tryEntries.push(b)}function A(a){var b=a.completion||{};b.type="normal",delete b.arg,a.completion=b}function B(a){this.tryEntries=[{tryLoc:"root"}],a.forEach(z,this),this.reset(!0)}function C(a){if(a||""===a){var b=a[F];if(b)return b.call(a);if("function"==typeof a.next)return a;if(!isNaN(a.length)){var c=-1,d=function b(){for(;++c<a.length;)if(t.call(a,c))return b.value=a[c],b.done=!1,b;return b.value=D,b.done=!0,b};return d.next=d}}throw new TypeError(_typeof(a)+" is not iterable")}_regeneratorRuntime=function(){return h};var D,h={},e=Object.prototype,t=e.hasOwnProperty,E=Object.defineProperty||function(a,b,c){a[b]=c.value},n="function"==typeof Symbol?Symbol:{},F=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";try{b({},"")}catch(a){b=function(a,b,c){return a[b]=c}}h.wrap=f;var G={},i={};b(i,F,function(){return this});var o=Object.getPrototypeOf,d=o&&o(o(C([])));d&&d!==e&&t.call(d,F)&&(i=d);var r=m.prototype=k.prototype=Object.create(i);return l.prototype=m,E(r,"constructor",{value:m,configurable:!0}),E(m,"constructor",{value:l,configurable:!0}),l.displayName=b(m,c,"GeneratorFunction"),h.isGeneratorFunction=function(a){var b="function"==typeof a&&a.constructor;return!!b&&(b===l||"GeneratorFunction"===(b.displayName||b.name))},h.mark=function(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,m):(a.__proto__=m,b(a,c,"GeneratorFunction")),a.prototype=Object.create(r),a},h.awrap=function(a){return{__await:a}},q(s.prototype),b(s.prototype,a,function(){return this}),h.AsyncIterator=s,h.async=function(b,c,d,e,g){void 0===g&&(g=Promise);var j=new s(f(b,c,d,e),g);return h.isGeneratorFunction(c)?j:j.next().then(function(a){return a.done?a.value:j.next()})},q(r),b(r,c,"Generator"),b(r,F,function(){return this}),b(r,"toString",function(){return"[object Generator]"}),h.keys=function(a){var b=Object(a),c=[];for(var d in b)c.push(d);return c.reverse(),function a(){for(;c.length;){var d=c.pop();if(d in b)return a.value=d,a.done=!1,a}return a.done=!0,a}},h.values=C,B.prototype={constructor:B,reset:function(a){if(this.prev=0,this.next=0,this.sent=this._sent=D,this.done=!1,this.delegate=null,this.method="next",this.arg=D,this.tryEntries.forEach(A),!a)for(var b in this)"t"===b.charAt(0)&&t.call(this,b)&&!isNaN(+b.slice(1))&&(this[b]=D)},stop:function(){this.done=!0;var a=this.tryEntries[0].completion;if("throw"===a.type)throw a.arg;return this.rval},dispatchException:function(b){function d(a,c){return h.type="throw",h.arg=b,e.next=a,c&&(e.method="next",e.arg=D),!!c}if(this.done)throw b;for(var e=this,f=this.tryEntries.length-1;0<=f;--f){var g=this.tryEntries[f],h=g.completion;if("root"===g.tryLoc)return d("end");if(g.tryLoc<=this.prev){var j=t.call(g,"catchLoc"),k=t.call(g,"finallyLoc");if(j&&k){if(this.prev<g.catchLoc)return d(g.catchLoc,!0);if(this.prev<g.finallyLoc)return d(g.finallyLoc)}else if(!j){if(!k)throw Error("try statement without catch or finally");if(this.prev<g.finallyLoc)return d(g.finallyLoc)}else if(this.prev<g.catchLoc)return d(g.catchLoc,!0)}}},abrupt:function(b,c){for(var d,e=this.tryEntries.length-1;0<=e;--e)if(d=this.tryEntries[e],d.tryLoc<=this.prev&&t.call(d,"finallyLoc")&&this.prev<d.finallyLoc){var f=d;break}f&&("break"===b||"continue"===b)&&f.tryLoc<=c&&c<=f.finallyLoc&&(f=null);var g=f?f.completion:{};return g.type=b,g.arg=c,f?(this.method="next",this.next=f.finallyLoc,G):this.complete(g)},complete:function(a,b){if("throw"===a.type)throw a.arg;return"break"===a.type||"continue"===a.type?this.next=a.arg:"return"===a.type?(this.rval=this.arg=a.arg,this.method="return",this.next="end"):"normal"===a.type&&b&&(this.next=b),G},finish:function(a){for(var b,c=this.tryEntries.length-1;0<=c;--c)if(b=this.tryEntries[c],b.finallyLoc===a)return this.complete(b.completion,b.afterLoc),A(b),G},catch:function(a){for(var b,c=this.tryEntries.length-1;0<=c;--c)if(b=this.tryEntries[c],b.tryLoc===a){var d=b.completion;if("throw"===d.type){var f=d.arg;A(b)}return f}throw Error("illegal catch attempt")},delegateYield:function(a,b,c){return this.delegate={iterator:C(a),resultName:b,nextLoc:c},"next"===this.method&&(this.arg=D),G}},h}function asyncGeneratorStep(b,d,f,e,g,h,a){try{var c=b[h](a),i=c.value}catch(a){return void f(a)}c.done?d(i):Promise.resolve(i).then(e,g)}function _asyncToGenerator(b){return function(){var c=this,d=arguments;return new Promise(function(e,f){function g(a){asyncGeneratorStep(i,e,f,g,h,"next",a)}function h(a){asyncGeneratorStep(i,e,f,g,h,"throw",a)}var i=b.apply(c,d);g(void 0)})}}import argon2 from"argon2";import sqlite3 from"sqlite3";import{open}from"sqlite";import{v4 as uuidv4}from"uuid";import"dotenv/config";import JWT from"jsonwebtoken";import{nanoid}from"nanoid";import validator from"validator";var db;_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function a(){return _regeneratorRuntime().wrap(function b(a){for(;1;)switch(a.prev=a.next){case 0:return a.next=2,open({filename:"./"+process.env.DB_NAME,driver:sqlite3.Database,mode:sqlite3.OPEN_READWRITE});case 2:db=a.sent;case 3:case"end":return a.stop()}},a)}))();function isUniqueUsername(a){return _isUniqueUsername.apply(this,arguments)}function _isUniqueUsername(){return _isUniqueUsername=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function b(a){var c,d;return _regeneratorRuntime().wrap(function e(b){for(;1;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,queryDB(db,"SELECT username FROM users WHERE username = ?;",[a]);case 3:d=b.sent,d?c=d.length:console.log("Could not verify username uniqueness: query returned undefined"),b.next=10;break;case 7:throw b.prev=7,b.t0=b["catch"](0),b.t0;case 10:return b.prev=10,b.finish(10);case 12:if(!c){b.next=14;break}return b.abrupt("return",c);case 14:throw new TypeError("Result of SQL Query was not an Array");case 15:case"end":return b.stop()}},b,null,[[0,7,10,12]])})),_isUniqueUsername.apply(this,arguments)}function queryDB(a,b,c){return _queryDB.apply(this,arguments)}function _queryDB(){return _queryDB=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function d(a,b,c){var e,f;return _regeneratorRuntime().wrap(function g(d){for(;1;)switch(d.prev=d.next){case 0:if(!a){d.next=14;break}return d.next=3,a.prepare(b);case 3:return e=d.sent,e.bind(c),d.next=7,e.all();case 7:if(f=d.sent,!Array.isArray(f)){d.next=10;break}return d.abrupt("return",f);case 10:return console.log("Error - Malformed Response"),d.abrupt("return",[]);case 14:return console.log("DB not ready"),d.abrupt("return",[]);case 16:case"end":return d.stop()}},d)})),_queryDB.apply(this,arguments)}function createUser(a,b,c){return _createUser.apply(this,arguments)}function _createUser(){return _createUser=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function d(a,b,c){var e,f,g,h,i;return _regeneratorRuntime().wrap(function j(d){for(;1;)switch(d.prev=d.next){case 0:return e="",f=uuidv4(),d.prev=2,d.next=5,isUniqueUsername(a);case 5:if(d.t0=d.sent,0!=d.t0){d.next=19;break}return d.next=9,argon2.hash(b,{type:argon2.argon2id,memoryCost:65536,timeCost:2,parallelism:1});case 9:return g=d.sent,d.next=12,queryDB(db,"INSERT INTO users (id, username, password, max_perms) VALUES (?, ?, ?, ?);",[f,a,g,c]);case 12:return h=d.sent,d.next=15,queryDB(db,"SELECT username FROM users WHERE username = ?;",[a]);case 15:i=d.sent,e=1==i.length?"Success":"",d.next=20;break;case 19:e="Username already in use";case 20:d.next=25;break;case 22:throw d.prev=22,d.t1=d["catch"](2),d.t1;case 25:return d.prev=25,d.finish(25);case 27:return d.abrupt("return",[e,f]);case 28:case"end":return d.stop()}},d,null,[[2,22,25,27]])})),_createUser.apply(this,arguments)}function validateCredentials(a,b){return _validateCredentials.apply(this,arguments)}function _validateCredentials(){return _validateCredentials=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function c(a,b){var d,e,f,g,h;return _regeneratorRuntime().wrap(function i(c){for(;1;)switch(c.prev=c.next){case 0:return d="Failed",f="none",c.prev=2,c.next=5,queryDB(db,"SELECT id, username, password, max_perms FROM users WHERE username = ?;",[a]);case 5:if(g=c.sent,!Array.isArray(g)){c.next=18;break}if(1!=g.length){c.next=18;break}return h=g[0].password,c.next=11,argon2.verify(h,b);case 11:if(!c.sent){c.next=15;break}c.t0="Correct credentials",c.next=16;break;case 15:c.t0="Incorrect credentials";case 16:d=c.t0,"Correct credentials"===d&&(f=g[0].max_perms,e=g[0].id);case 18:c.next=23;break;case 20:throw c.prev=20,c.t1=c["catch"](2),c.t1;case 23:return c.prev=23,c.finish(23);case 25:if(!e){c.next=27;break}return c.abrupt("return",[d,e,f]);case 27:return c.abrupt("return",[d,f]);case 28:case"end":return c.stop()}},c,null,[[2,20,23,25]])})),_validateCredentials.apply(this,arguments)}export function createAuthRoute(a){return/*#__PURE__*/function(){function b(a,b){return c.apply(this,arguments)}var c=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function d(b,c){var e,f,g,h,i,j,k,l;return _regeneratorRuntime().wrap(function m(d){for(;1;)switch(d.prev=d.next){case 0:if(e=b.body.username,f=b.body.password,g="Failed",h=!0,j="none",!h){d.next=13;break}return d.next=8,isUniqueUsername(e);case 8:if(k=d.sent,1!=k){d.next=13;break}return d.next=12,validateCredentials(e,f);case 12:i=d.sent;case 13:return i&&i[0]&&(g="Success",j=i[i.length-1]),d.next=16,createAuthJWT(j);case 16:l=d.sent,c.cookie(process.env.COOKIE_NAME,l,a),c.json({status:g});case 19:case"end":return d.stop()}},d)}));return b}()}function checkAccess(a,b,c,d){return _checkAccess.apply(this,arguments)}function _checkAccess(){var a=Math.floor;return _checkAccess=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function f(b,c,d,e){var g,h,i,j,k,l,m,n,o,p;return _regeneratorRuntime().wrap(function q(f){for(;1;)switch(f.prev=f.next){case 0:if(g=process.env.JWT_KEY,f.prev=1,h=validator.isJWT(b),h){f.next=5;break}return f.abrupt("return",!1);case 5:f.next=11;break;case 7:return f.prev=7,f.t0=f["catch"](1),console.log(f.t0),f.abrupt("return",!1);case 11:if(f.prev=11,j=JWT.verify(b,g,e),i="string"==typeof j?JSON.parse(j):j,!("lvl"in i)){f.next=27;break}if(k=!1,e&&"endpoints"in e&&null!=e.endpoints&&(k=e.endpoints[i.lvl].includes(c)),!k&&"urls"in i&&Array.isArray(i.urls)&&(k=validateURLArray(i.urls)&&i.urls.includes(c)),!0!==k){f.next=24;break}return f.next=21,queryDB(db,"SELECT jti, last_used FROM jwt WHERE jti = ?",[i.jti]);case 21:l=f.sent,m=a(Date.now()/1e3)-60*d,(1!==l.length||1==l.length&&l[0].last_used<=m)&&(k=!1);case 24:return f.abrupt("return",k);case 27:return f.abrupt("return",!1);case 28:f.next=50;break;case 30:if(f.prev=30,f.t1=f["catch"](11),!(f.t1 instanceof JWT.JsonWebTokenError)){f.next=48;break}if(!(f.t1 instanceof JWT.TokenExpiredError)){f.next=43;break}if(p=JWT.decode(b,e),null==p){f.next=40;break}if(o="string"==typeof p?JSON.parse(p):p,!("lvl"in o)){f.next=40;break}return f.next=40,queryDB(db,"DELETE FROM jwt WHERE jti = ?;",[o.jti]);case 40:return f.abrupt("return",!1);case 43:f.t1 instanceof JWT.NotBeforeError&&(n=". Date: "+f.t1.date);case 44:return console.log(f.t1.name+": "+f.t1.message+(null==n?"":n)),f.abrupt("return",!1);case 48:throw f.t1;case 50:case"end":return f.stop()}},f,null,[[1,7],[11,30]])})),_checkAccess.apply(this,arguments)}function createJWT(a,b){var c=process.env.JWT_KEY,d=JWT.sign(a,c,b);return d}function createAuthJWT(a,b){return _createAuthJWT.apply(this,arguments)}function _createAuthJWT(){return _createAuthJWT=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function c(a,b){var d,e,f,g;return _regeneratorRuntime().wrap(function h(c){for(;1;)switch(c.prev=c.next){case 0:if(d=nanoid(),e={lvl:a},Array.isArray(b)&&(e.urls=b),f=createJWT(e,{jwtid:d,expiresIn:"3h",mutatePayload:!0}),null!=e.iat){c.next=6;break}throw new TypeError("Error: JWT iat not set in payload");case 6:return c.next=8,queryDB(db,"INSERT INTO jwt (jti, last_used) VALUES (?, ?);",[d,e.iat.toString()]);case 8:return c.next=10,queryDB(db,"SELECT * FROM jwt WHERE jti = ?;",[d]);case 10:if(g=c.sent.length,1!==g){c.next=13;break}return c.abrupt("return",f);case 13:throw new Error("NanoID Collision Found");case 14:case"end":return c.stop()}},c)})),_createAuthJWT.apply(this,arguments)}function validateURLArray(a){return a.reduce(function(a,b){return a&&validator.isURL(b,{protocols:["http","https"],require_tld:!1,require_host:!1,allow_underscores:!0,allow_protocol_relative_urls:!0,allow_query_components:!1})},!0)}export function createRegisterRoute(a){return/*#__PURE__*/function(){function b(a,b){return c.apply(this,arguments)}var c=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function d(b,c){var e,f,g,h,i,j,k;return _regeneratorRuntime().wrap(function l(d){for(;1;)switch(d.prev=d.next){case 0:if(e=b.body.username,f=b.body.password,g=b.body.permsLevel||"basic",h=Array.isArray(b.body.urls)&&validateURLArray(b.body.urls)?b.body.urls:null,i=null!=h,j="Failed",!i){d.next=15;break}return d.next=9,isUniqueUsername(e);case 9:if(d.t0=d.sent,0!=d.t0){d.next=15;break}return d.next=13,createUser(e,f,g);case 13:k=d.sent,j=k[0]?"Successful Creation of User":"Failed";case 15:c.json({status:j}),c.cookie(process.env.COOKIE_NAME,createAuthJWT(g,h),a);case 17:case"end":return d.stop()}},d)}));return b}()}export function createRemoveStaleJWTsMiddleware(a){return function(b,c,d){var e=Math.floor(Date.now()/1e3)-60*a;queryDB(db,"DELETE FROM jwt WHERE last_used < ?;",[e.toString()]),d()}}export function createCheckAuthMiddleware(a,b){return/*#__PURE__*/function(){var c=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function f(c,d,e){var g;return _regeneratorRuntime().wrap(function f(d){for(;1;)switch(d.prev=d.next){case 0:if(g=c.signedCookies[process.env.COOKIE_NAME],!a.none.includes(c.path)){d.next=5;break}e(),d.next=15;break;case 5:if(d.t0=!1!==g,!d.t0){d.next=10;break}return d.next=9,checkAccess(g,c.path,b,{endpoints:a});case 9:d.t0=d.sent;case 10:if(!d.t0){d.next=14;break}e(),d.next=15;break;case 14:e("route");case 15:case"end":return d.stop()}},f)}));return function(a,b,d){return c.apply(this,arguments)}}()}export default{createAuthRoute:createAuthRoute,createCheckAuthMiddleware:createCheckAuthMiddleware,createRegisterRoute:createRegisterRoute,createRemoveStaleJWTsMiddleware:createRemoveStaleJWTsMiddleware};