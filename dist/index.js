import path from"node:path";import express from"express";import sshProxy from"./sshProxy.js";import auth from"./auth.js";import helmet from"helmet";import toobusy from"toobusy-js";import fetch from"isomorphic-fetch";import"dotenv/config";import cookieParser from"cookie-parser";var app=express(),endpoints={none:["/","/login","/captcha","/auth"],full:["/test-auth-status"]},cookieOptions={domain:"lvoz2.duckdns.org",maxAge:36e5,path:"/",httpOnly:!0,sameSite:"strict",secure:!0,signed:!0},timeout=15,checkAuth=auth.createCheckAuthMiddleware(endpoints,timeout);app.set("trust proxy",1),app.use(auth.createRemoveStaleJWTsMiddleware(timeout)),app.use(express["static"]("static")),app.use(express.json()),app.use(cookieParser(process.env.COOKIE_KEY)),app.use(helmet({contentSecurityPolicy:!1,xContentTypeOptions:!1,strictTransportSecurity:!1,crossOriginResourcePolicy:!1,referrerPolicy:!1})),app.use(function(a,b,c){toobusy()?b.status(503).send("Server Too Busy"):c()}),app.post("/echo",checkAuth,function(a,b){b.json(a.body)}),app.get("/hello",checkAuth,function(a,b){b.send("Hello World")}),app.post("/auth",checkAuth,auth.createAuthRoute(cookieOptions)),app.post("/register",checkAuth,auth.createRegisterRoute(cookieOptions)),app.get("/test-auth-status",checkAuth,function(a,b){b.json({status:"Success"})}),app.post("/captcha",checkAuth,function(a,b){var c=process.env.CAPTCHA_SECRET_KEY,d=a.body.token;fetch("https://www.google.com/recaptcha/api/siteverify?secret="+c+"&response="+d,{method:"post"}).then(function(a){return a.json()}).then(function(a){return b.json({google_response:a})})["catch"](function(a){return b.json({error:a})})}),app.get("/ssh/update",checkAuth,sshProxy.update),app.get("/ssh/input",checkAuth,sshProxy.input),app.use(function(a,b){return b.status(404),a.accepts("html")?void b.sendFile(path.resolve("./http_errors/404.html")):a.accepts("json")?void b.json({error:"Not found"}):void b.type("txt").send("Not found")}),app.listen(3e3);